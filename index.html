<html>
<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<!-- Load the d3 library. -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<style type="text/css">
svg{ background-color: lightgrey;
}
.possent {
	fill:green;
}
.negsent {
	fill:red;
}
.neutralsent {
	fill:grey;
}
.yaxis{display:none;}
.tick text{font-size: 8pt;}
.states {
        	fill: #aaa;
        	stroke: #fff;
        	stroke-width: 0.75px;
	}
</style>
</head>
<body>
	<svg id = "map" height = "500" width = "960"></svg><br><br>
	<script>
	//FUNCTION TAKEN FROM GITHUB USER CalebGrove
	// USAGE:
	// abbrState('ny', 'name');
	// --> 'New York'
	// abbrState('New York', 'abbr');
	// --> 'NY'
	function abbrState(input, to){
	    var states = [
	        ['Arizona', 'AZ'],
	        ['Alabama', 'AL'],
	        ['Alaska', 'AK'],
	        ['Arizona', 'AZ'],
	        ['Arkansas', 'AR'],
	        ['California', 'CA'],
	        ['Colorado', 'CO'],
	        ['Connecticut', 'CT'],
	        ['Delaware', 'DE'],
	        ['Florida', 'FL'],
	        ['Georgia', 'GA'],
	        ['Hawaii', 'HI'],
	        ['Idaho', 'ID'],
	        ['Illinois', 'IL'],
	        ['Indiana', 'IN'],
	        ['Iowa', 'IA'],
	        ['Kansas', 'KS'],
	        ['Kentucky', 'KY'],
	        ['Kentucky', 'KY'],
	        ['Louisiana', 'LA'],
	        ['Maine', 'ME'],
	        ['Maryland', 'MD'],
	        ['Massachusetts', 'MA'],
	        ['Michigan', 'MI'],
	        ['Minnesota', 'MN'],
	        ['Mississippi', 'MS'],
	        ['Missouri', 'MO'],
	        ['Montana', 'MT'],
	        ['Nebraska', 'NE'],
	        ['Nevada', 'NV'],
	        ['New Hampshire', 'NH'],
	        ['New Jersey', 'NJ'],
	        ['New Mexico', 'NM'],
	        ['New York', 'NY'],
	        ['North Carolina', 'NC'],
	        ['North Dakota', 'ND'],
	        ['Ohio', 'OH'],
	        ['Oklahoma', 'OK'],
	        ['Oregon', 'OR'],
	        ['Pennsylvania', 'PA'],
	        ['Rhode Island', 'RI'],
	        ['South Carolina', 'SC'],
	        ['South Dakota', 'SD'],
	        ['Tennessee', 'TN'],
	        ['Texas', 'TX'],
	        ['Utah', 'UT'],
	        ['Vermont', 'VT'],
	        ['Virginia', 'VA'],
	        ['Washington', 'WA'],
	        ['West Virginia', 'WV'],
	        ['Wisconsin', 'WI'],
	        ['Wyoming', 'WY'],
	    ];

	    if (to == 'abbr'){
	        input = input.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	        for(i = 0; i < states.length; i++){
	            if(states[i][0] == input){
	                return(states[i][1]);
	            }
	        }    
	    } else if (to == 'name'){
	        input = input.toUpperCase();
	        for(i = 0; i < states.length; i++){
	            if(states[i][1] == input){
	                return(states[i][0]);
	            }
	        }    
	    }
	}
	//function that gets the state sentiments for an input state
	function getStateSentiments(state,data){
		var result = [];
		var abbr = abbrState(state,"abbr");
		data.forEach(function(i){
			if(i.location.indexOf(abbr) != -1 || i.location.indexOf(state) != -1){
				result.push(i);
			}
		});
		return result;
	};


	var primaryresults = [
		{state:"Iowa",winner:"Ted Cruz"},
		{state:"New Hampshire",winner:"Donald Trump"},
		{state:"South Carolina",winner:"Donald Trump"},
		{state:"Nevada",winner:"Donald Trump"},
		{state:"Alabama",winner:"Donald Trump"},
		{state:"Alaska",winner:"Ted Cruz"},
		{state:"Arkansas",winner:"Donald Trump"},
		{state:"Georgia",winner:"Donald Trump"},
		{state:"Massachusetts",winner:"Donald Trump"},
		{state:"Minnesota",winner:"Marco Rubio"},
		{state:"Oklahoma",winner:"Ted Cruz"},
		{state:"Tennessee",winner:"Donald Trump"},
		{state:"Texas",winner:"Ted Cruz"},
		{state:"Vermont",winner:"Donald Trump"},
		{state:"Virginia",winner:"Donald Trump"}
	];

	var sentimentFrequencies = [
		{"candidate":"Donald Trump","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Ted Cruz","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Marco Rubio","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Ben Carson","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Mike Huckabee","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Chris Christie","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"John Kasich","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Jeb Bush","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Scott Walker","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Rand Paul","possent":0,"negsent":0,"neutralsent":0}
		];

	data = [];

	primaryresults.forEach(function(primary){
		sentimentFrequencies.forEach(function(entry){
				newentry = {
					"state":primary.state,
					"candidate":entry.candidate,
					"possent":entry.possent,
					"negsent":entry.negsent,
					"neutralsent":entry.neutralsent
				};
				data.push(newentry);
		});
	});
	//Function taken from stackoverflow user aston
	function changeDesc( candidate,sentiment,data,state) {
			for (var i in data) {
				if (data[i].candidate == candidate && data[i].state == state) {
				if(sentiment == "possent"){
					data[i].possent = data[i].possent+1;
				} else if(sentiment == "negsent"){
					data[i].negsent = data[i].negsent+1;
				} else {
					data[i].neutralsent = data[i].neutralsent+1;
				}
					break; //Stop this loop, we found it!
				}
			}
	}


	//Get data for each candidate by state
	var sentiments = [];
	d3.csv("State_Sentiment.csv", function(f){
		
		//Parse data into javascript array of objects
		f.forEach(function(r){
		sentiments.push({
			candidate: r.candidate,
			sentiment: r.sentiment,
			retweet: r.retweet_count,
			location: r.tweet_location
		});
		});
		//Iterate through states where primaries have occurred and tally up candidates sentiments
		primaryresults.forEach(function(primary){
			var stateSentiments = getStateSentiments(primary.state,sentiments);
			stateSentiments.forEach(function(tweet){
				var candidate = tweet.candidate;
				if(tweet.sentiment == "Positive"){
					changeDesc(candidate,"possent",data,primary.state);
				} else if(tweet.sentiment == "Negative") {
					changeDesc(candidate,"negsent",data,primary.state);
				} else {
					changeDesc(candidate,"neutralsent",data,primary.state);
				}
			});	
		});
		//console.log(data);
	});

    
	</script>
</body>
</html>