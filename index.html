<html>
<head>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<!-- Load the d3 library. -->
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<style type="text/css">

.possent {
	fill:green;
}
.negsent {
	fill:red;
}
.neutralsent {
	fill:grey;
}
.yaxis{display:none;}
.tick text{font-size: 8pt;}
.states {
        	fill: #aaa;
        	stroke: #fff;
        	stroke-width: 0.75px;
	}
</style>
</head>
<body>
	<svg id="key" width="600" height="100"></svg><br>
	<svg id = "trump" width="600" height="600"></svg><br><br>
	<svg id = "cruz" width="600" height="600"></svg><br><br>
	<svg id = "rubio" width="600" height="600"></svg>
	<script>
	//FUNCTION TAKEN FROM GITHUB USER CalebGrove
	// USAGE:
	// abbrState('ny', 'name');
	// --> 'New York'
	// abbrState('New York', 'abbr');
	// --> 'NY'
	function abbrState(input, to){
	    var states = [
	        ['Arizona', 'AZ'],
	        ['Alabama', 'AL'],
	        ['Alaska', 'AK'],
	        ['Arizona', 'AZ'],
	        ['Arkansas', 'AR'],
	        ['California', 'CA'],
	        ['Colorado', 'CO'],
	        ['Connecticut', 'CT'],
	        ['Delaware', 'DE'],
	        ['Florida', 'FL'],
	        ['Georgia', 'GA'],
	        ['Hawaii', 'HI'],
	        ['Idaho', 'ID'],
	        ['Illinois', 'IL'],
	        ['Indiana', 'IN'],
	        ['Iowa', 'IA'],
	        ['Kansas', 'KS'],
	        ['Kentucky', 'KY'],
	        ['Kentucky', 'KY'],
	        ['Louisiana', 'LA'],
	        ['Maine', 'ME'],
	        ['Maryland', 'MD'],
	        ['Massachusetts', 'MA'],
	        ['Michigan', 'MI'],
	        ['Minnesota', 'MN'],
	        ['Mississippi', 'MS'],
	        ['Missouri', 'MO'],
	        ['Montana', 'MT'],
	        ['Nebraska', 'NE'],
	        ['Nevada', 'NV'],
	        ['New Hampshire', 'NH'],
	        ['New Jersey', 'NJ'],
	        ['New Mexico', 'NM'],
	        ['New York', 'NY'],
	        ['North Carolina', 'NC'],
	        ['North Dakota', 'ND'],
	        ['Ohio', 'OH'],
	        ['Oklahoma', 'OK'],
	        ['Oregon', 'OR'],
	        ['Pennsylvania', 'PA'],
	        ['Rhode Island', 'RI'],
	        ['South Carolina', 'SC'],
	        ['South Dakota', 'SD'],
	        ['Tennessee', 'TN'],
	        ['Texas', 'TX'],
	        ['Utah', 'UT'],
	        ['Vermont', 'VT'],
	        ['Virginia', 'VA'],
	        ['Washington', 'WA'],
	        ['West Virginia', 'WV'],
	        ['Wisconsin', 'WI'],
	        ['Wyoming', 'WY'],
	    ];

	    if (to == 'abbr'){
	        input = input.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
	        for(i = 0; i < states.length; i++){
	            if(states[i][0] == input){
	                return(states[i][1]);
	            }
	        }    
	    } else if (to == 'name'){
	        input = input.toUpperCase();
	        for(i = 0; i < states.length; i++){
	            if(states[i][1] == input){
	                return(states[i][0]);
	            }
	        }    
	    }
	}
	//function that gets the state sentiments for an input state
	function getStateSentiments(state,data){
		var result = [];
		var abbr = abbrState(state,"abbr");
		data.forEach(function(i){
			if(i.location.indexOf(abbr) != -1 || i.location.indexOf(state) != -1){
				result.push(i);
			}
		});
		return result;
	};


	var primaryresults = [
		{state:"Iowa",winner:"Ted Cruz"},
		{state:"New Hampshire",winner:"Donald Trump"},
		{state:"South Carolina",winner:"Donald Trump"},
		{state:"Nevada",winner:"Donald Trump"},
		{state:"Alabama",winner:"Donald Trump"},
		{state:"Alaska",winner:"Ted Cruz"},
		{state:"Arkansas",winner:"Donald Trump"},
		{state:"Georgia",winner:"Donald Trump"},
		{state:"Massachusetts",winner:"Donald Trump"},
		{state:"Minnesota",winner:"Marco Rubio"},
		{state:"Oklahoma",winner:"Ted Cruz"},
		{state:"Tennessee",winner:"Donald Trump"},
		{state:"Texas",winner:"Ted Cruz"},
		{state:"Vermont",winner:"Donald Trump"},
		{state:"Virginia",winner:"Donald Trump"}
	];

	var sentimentFrequencies = [
		{"candidate":"Donald Trump","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Ted Cruz","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Marco Rubio","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Ben Carson","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Mike Huckabee","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Chris Christie","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"John Kasich","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Jeb Bush","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Scott Walker","possent":0,"negsent":0,"neutralsent":0},
		{"candidate":"Rand Paul","possent":0,"negsent":0,"neutralsent":0}
		];

	data = [];

	primaryresults.forEach(function(primary){
		sentimentFrequencies.forEach(function(entry){
				newentry = {
					"state":primary.state,
					"winner":primary.winner,
					"candidate":entry.candidate,
					"possent":entry.possent,
					"negsent":entry.negsent,
					"neutralsent":entry.neutralsent
				};
				data.push(newentry);
		});
	});
	//Function taken from stackoverflow user aston
	function changeDesc( candidate,sentiment,data,state) {
			for (var i in data) {
				if (data[i].candidate == candidate && data[i].state == state) {
				if(sentiment == "possent"){
					data[i].possent = data[i].possent+1;
				} else if(sentiment == "negsent"){
					data[i].negsent = data[i].negsent+1;
				} else {
					data[i].neutralsent = data[i].neutralsent+1;
				}
					break; //Stop this loop, we found it!
				}
			}
	}

	function drawData(sentimentArray, candidateName, candidateImg, id, stateOrder) {
		var width = 500,
			height = 500,
			radius = 250;

        var sentimentColors = ['#F78181', '#DF0101', '#B40404'];
        var stateColors = ['#B0B7FF', "#4B4E72"];

        var numStateBars = stateOrder.length;
        var numSentimentBars = sentimentArray.length;

        var svg = d3.select(id)
          			.append('svg')
          			.attr('width', width)
          			.attr('height', height)
          			.append('g')
          			.attr('transform', 'translate(250,250)');

        var statesArc = d3.svg.arc()
          					  .outerRadius(radius)
          					  .innerRadius(0)
          					  .startAngle(function(d,i) { return (i * 2 * Math.PI) / numStateBars; })
      						  .endAngle(function(d,i) { return ((i + 1) * 2 * Math.PI) / numStateBars; });

      	var statesPie = d3.layout.pie().sort(null).value(function(d) { return d.count; });

        var backgroundArc = d3.svg.arc()
						.outerRadius(radius)
						.startAngle(function(d,i) { return (i * 2 * Math.PI) / numStateBars; })
						.endAngle(function(d,i) { return ((i + 1) * 2 * Math.PI) / numStateBars; });

      	

      	var statesPath = svg.selectAll('.states')
          					.data(statesPie(stateOrder))
          					.enter()
          					.append('path')
          					.attr('d', statesArc)
          					.attr('class', '.states')
          					.attr('fill', function(d, i) {
          						if (d.data.winner == candidateName) {
          							return stateColors[0]; 
          						} else {
          							return stateColors[1];
          						} })
          					.style('stroke', '2E2E2E')
  							.style('stroke-width', '2');

        var heightScale = d3.scale.linear().domain([0,1]).range([150,radius-50]);


        var sentimentsArc = d3.svg.arc()
        						.startAngle(function(d,i) { return ((i * 2 * Math.PI) / numSentimentBars); })
      							.endAngle(function(d,i) { return ((i + 1) * 2 * Math.PI) / numSentimentBars; });

        var sentimentPie = d3.layout.pie().sort(null).value(function(d) { return d.count; });

        var sentimentPath = svg.selectAll('.sentiments')
          .data(sentimentPie(sentimentArray))
          .enter()
          .append('path')
          .attr('d', function(d, i) { return sentimentsArc.outerRadius(heightScale(d.data))(d,i); })
          .attr('class', '.sentiments')
          .attr('fill', function(d, i) {
          	if (d.data == 0) {
          		return "none";
          	} 
            return sentimentColors[i%3];
          });

        var backgroundPath = svg.selectAll('.background')
          						.data(statesPie(stateOrder))
          						.enter()
          						.append('path')
          						.attr('d', backgroundArc)
          						.attr('class', '.background')
          						.attr('fill', 'none')
          						.style('stroke', '2E2E2E')
  								.style('stroke-width', '1');

        var img = svg.append("svg:image")
    				.attr("xlink:href", candidateImg)
    				.attr("width", 150)
				    .attr("height", 150)
				    .attr("x", -75)
				    .attr("y",-75);

	};


	//Get data for each candidate by state
	var sentiments = [];
	d3.csv("State_Sentiment.csv", function(f){
		
		//Parse data into javascript array of objects
		f.forEach(function(r){
		sentiments.push({
			candidate: r.candidate,
			sentiment: r.sentiment,
			retweet: r.retweet_count,
			location: r.tweet_location
		});
		});
		//Iterate through states where primaries have occurred and tally up candidates sentiments
		primaryresults.forEach(function(primary){
			var stateSentiments = getStateSentiments(primary.state,sentiments);
			stateSentiments.forEach(function(tweet){
				var candidate = tweet.candidate;
				if(tweet.sentiment == "Positive"){
					changeDesc(candidate,"possent",data,primary.state);
				} else if(tweet.sentiment == "Negative") {
					changeDesc(candidate,"negsent",data,primary.state);
				} else {
					changeDesc(candidate,"neutralsent",data,primary.state);
				}
			});	
		});
		
		trumpSentiments = [];
		cruzSentiments = [];
		rubioSentiments = [];
		stateOrder = [];

		data.forEach(function (d) {
			var totalSentiments = d.possent+d.neutralsent+d.negsent;
			if (totalSentiments==0) {totalSentiments = 1;}
			if (d.candidate == "Donald Trump") {
				trumpSentiments.push(d.possent/totalSentiments);
				trumpSentiments.push(d.neutralsent/totalSentiments);
				trumpSentiments.push(d.negsent/totalSentiments);
				stateOrder.push({'state':d.state,'winner':d.winner});
			}
			if (d.candidate == "Ted Cruz") {
				cruzSentiments.push(d.possent/totalSentiments);
				cruzSentiments.push(d.neutralsent/totalSentiments);
				cruzSentiments.push(d.negsent/totalSentiments);
			}
			if (d.candidate == "Marco Rubio") {
				rubioSentiments.push(d.possent/totalSentiments);
				rubioSentiments.push(d.neutralsent/totalSentiments);
				rubioSentiments.push(d.negsent/totalSentiments);
			}
		});

		// Start svg here
		var svg = d3.select("#key")
          			.append('svg')
          			.attr('width', 600)
          			.attr('height', 100);

        var g = svg.append('g');

        g.append("text")
         .attr("x", 20)
         .attr("y", 0)
         .attr("dominant-baseline", "middle")
         .text("Twitter Sentiment ");

        g.append("rect")
         .attr("x", 20)
         .attr("y", 20)
         .attr("width", 20)
         .attr("height", 20)
         .style("fill", "#F78181")

        g.append("text")
         .attr("x", 45)
         .attr("y", 30)
         .attr("dominant-baseline", "middle")
         .text("Positive");


        g.append("rect")
         .attr("x", 20)
         .attr("y", 50)
         .attr("width", 20)
         .attr("height", 20)
         .style("fill", "#DF0101")

        g.append("text")
         .attr("x", 45)
         .attr("y", 60)
         .attr("dominant-baseline", "middle")
         .text("Neutral");


        g.append("rect")
         .attr("x", 20)
         .attr("y", 80)
         .attr("width", 20)
         .attr("height", 20)
         .style("fill", "#B40404")

        g.append("text")
         .attr("x", 45)
         .attr("y", 90)
         .attr("dominant-baseline", "middle")
         .text("Negative");


        g.append("rect")
         .attr("x", 200)
         .attr("y", 20)
         .attr("width", 20)
         .attr("height", 20)
         .style("fill", "#0040FF")

        g.append("text")
         .attr("x", 225)
         .attr("y", 30)
         .attr("dominant-baseline", "middle")
         .text("Won");

         g.append("rect")
         .attr("x", 200)
         .attr("y", 50)
         .attr("width", 20)
         .attr("height", 20)
         .style("fill", "#0B0B61")

        g.append("text")
         .attr("x", 225)
         .attr("y", 60)
         .attr("dominant-baseline", "middle")
         .text("Lost");

         

		drawData(trumpSentiments, "Donald Trump", 'http://media.cq.com/images/trump-circle.png', '#trump', stateOrder);
		drawData(cruzSentiments, "Ted Cruz", 'http://media.cq.com/images/cruz-circle.png', '#cruz', stateOrder);
		drawData(cruzSentiments, "Marco Rubio", 'http://media.cq.com/images/rubio-circle.png', '#rubio', stateOrder);


	});

    
	</script>
</body>
</html>